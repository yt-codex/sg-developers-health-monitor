name: Update dashboard data

on:
  workflow_dispatch:
  schedule:
    - cron: '0 1 * * *'
  push:
    branches: [main]
    paths:
      - 'data/**'
      - 'scripts/**'
      - '.github/workflows/**'
      - 'package.json'

permissions:
  contents: write

jobs:
  refresh-data:
    runs-on: ubuntu-latest
    env:
      DATA_GOV_SG_API_KEY: ${{ secrets.DATA_GOV_SG_API_KEY }}
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: npm
      - name: Install dependencies
        run: npm ci
      - name: Refresh developer ratios pipeline
        run: npm run refresh:developer-ratios
      - name: Refresh metadata timestamps
        run: |
          python - <<'PY'
          import json
          from datetime import datetime, timezone
          files = [
            'data/site_meta.json',
            'data/macro_indicators.json',
            'data/developer_news.json',
            'data/listed_developers.json',
            'data/risk_rules.json'
          ]
          now_iso = datetime.now(timezone.utc).isoformat()
          for path in files:
            with open(path, 'r', encoding='utf-8') as f:
              data = json.load(f)
            if path.endswith('site_meta.json'):
              data['lastUpdated'] = now_iso
            else:
              data.setdefault('meta', {})['asOf'] = now_iso[:10]
            with open(path, 'w', encoding='utf-8') as f:
              json.dump(data, f, indent=2)
          PY
      - name: Commit updates
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git add data/
          git diff --staged --quiet || git commit -m "chore(data): refresh dashboard data outputs"
          git push
